on:
  pull_request:
    types: [opened, synchronize]

jobs:
  check-plagiarism:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout PR
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Instalar dependências
        run: pip install -r requirements.txt
      
      - name: Detectar similaridade entre códigos
        id: plagiarism-check
        run: |
          python3 << 'PYTHON_SCRIPT'
          import os
          import difflib
          import re
          from pathlib import Path

          def normalize_code(code):
              """Normalize code by removing comments, extra spaces, and lowering case."""
              code = re.sub(r'<!--.*?-->', '', code, flags=re.DOTALL)  # Remove HTML comments
              code = re.sub(r'//.*?', '', code, flags=re.MULTILINE)  # Remove JS comments
              code = re.sub(r'/\*.*?\*/', '', code, flags=re.DOTALL)  # Remove multiline comments
              code = re.sub(r'\s+', ' ', code)  # Remove extra spaces
              return code.lower().strip()

          def calculate_similarity(code1, code2):
              """Calculate similarity between two normalized code strings."""
              matcher = difflib.SequenceMatcher(None, normalize_code(code1), normalize_code(code2))
              return matcher.ratio() * 100

          submissions = {}
          suspicious = []
          THRESHOLD = 85

          exercicios_dir = Path('exercicios')
          for aula_dir in exercicios_dir.glob('aula*/'):
              for file_type in ['index.html', 'script.js', 'style.css']:
                  file_path = aula_dir / file_type
                  if file_path.exists():
                      with open(file_path, 'r', encoding='utf-8', errors='ignore') as f:
                          submissions[file_path] = f.read()

          for file, content in submissions.items():
              if 'TODO' in content:
                  suspicious.append({
                      'file': str(file),
                      'reason': 'Template not implemented (contains TODO)'
                  })

          if suspicious:
              print("⚠️ Suspicious code detected:")
              for suspect in suspicious:
                  print(f"  - {suspect['file']}: {suspect['reason']}")
              with open(os.getenv('GITHUB_OUTPUT'), 'a') as output:
                  output.write("suspicious=true\n")
          else:
              print("✅ No suspicious code detected.")
              with open(os.getenv('GITHUB_OUTPUT'), 'a') as output:
                  output.write("suspicious=false\n")
          PYTHON_SCRIPT

      - name: Comment on Suspicious Code
        if: steps.plagiarism-check.outputs.suspicious == 'true'
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `⚠️ Suspicious code detected. Please review your submission and ensure code is original and complete.`
            });